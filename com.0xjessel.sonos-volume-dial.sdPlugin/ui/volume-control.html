<!DOCTYPE html>
<html>
<head lang="en">
    <title>Sonos Volume Control Settings</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../libs/css/sdpi.css">
</head>

<body>
    <div class="sdpi-wrapper">
        <!-- IP Address Input -->
        <div class="sdpi-item">
            <div class="sdpi-item-label">Speaker IP</div>
            <input class="sdpi-item-value" type="text" id="speakerIp" setting="speakerIp" placeholder="192.168.1.100">
        </div>

        <!-- Volume Step Configuration -->
        <div class="sdpi-item">
            <div class="sdpi-item-label">Volume Step</div>
            <select class="sdpi-item-value" id="volumeStep" setting="volumeStep">
                <option value="1">1%</option>
                <option value="2">2%</option>
                <option value="5" selected>5%</option>
                <option value="10">10%</option>
            </select>
        </div>

        <!-- Debug Output -->
        <div class="sdpi-item">
            <div class="sdpi-item-label">Status</div>
            <div class="sdpi-item-value" id="debugOutput">Not Connected</div>
        </div>
    </div>

    <!-- Stream Deck Property Inspector Library -->
    <script src="../libs/js/property-inspector.js"></script>

    <script>
        console.log('Property Inspector script starting...');

        // Load Stream Deck library
        let websocket = null;
        let pluginAction = null;
        let currentSettings = {};

        function updateDebugOutput(message) {
            const debugOutput = document.getElementById("debugOutput");
            debugOutput.textContent = message;
            console.log(message);
        }

        // Connect to Stream Deck
        window.connectElgatoStreamDeckSocket = function(inPort, inPluginUUID, inRegisterEvent, inInfo) {
            updateDebugOutput('Connecting to Stream Deck...');
            console.log('Raw connection params:', { port: inPort, uuid: inPluginUUID, registerEvent: inRegisterEvent, info: inInfo });
            
            // Use the plugin UUID as the context for property inspector
            pluginAction = inPluginUUID;
            
            websocket = new WebSocket("ws://127.0.0.1:" + inPort);

            websocket.onopen = function() {
                updateDebugOutput('WebSocket Connected');

                // Register plugin with Stream Deck
                const registerEvent = {
                    event: inRegisterEvent,
                    uuid: inPluginUUID
                };
                console.log('Sending register event:', registerEvent);
                websocket.send(JSON.stringify(registerEvent));

                // Request current settings
                const getSettingsEvent = {
                    event: "getSettings",
                    context: pluginAction
                };
                console.log('Requesting settings:', getSettingsEvent);
                websocket.send(JSON.stringify(getSettingsEvent));
            };

            websocket.onmessage = function(evt) {
                console.log('Raw WebSocket message:', evt.data);
                
                const jsonObj = JSON.parse(evt.data);
                const { event, payload } = jsonObj;

                updateDebugOutput(`Received event: ${event}`);

                if (event === "didReceiveSettings") {
                    console.log('Settings received:', payload.settings);
                    currentSettings = payload.settings;
                    updateUI(payload.settings);
                }
            };

            websocket.onerror = function(evt) {
                console.error('WebSocket error:', evt);
                updateDebugOutput('WebSocket Error');
            };

            websocket.onclose = function(evt) {
                console.log('WebSocket closed:', evt);
                updateDebugOutput('WebSocket Closed');
            };
        }

        // Update UI with settings
        function updateUI(settings) {
            updateDebugOutput('Updating UI with settings');
            
            // Update IP address input
            const ipInput = document.getElementById("speakerIp");
            if (settings.speakerIp !== undefined) {
                ipInput.value = settings.speakerIp;
            }

            // Update volume step select
            const stepSelect = document.getElementById("volumeStep");
            if (settings.volumeStep !== undefined) {
                stepSelect.value = settings.volumeStep.toString();
            }
        }

        // Save settings when inputs change
        function saveSettings() {
            if (!websocket) return;

            const speakerIp = document.getElementById("speakerIp").value;
            const volumeStep = parseInt(document.getElementById("volumeStep").value);

            updateDebugOutput('Saving settings...');

            // Merge with current settings to preserve other values
            const settings = {
                ...currentSettings,
                speakerIp,
                volumeStep
            };

            // Update our local copy
            currentSettings = settings;

            // Send to Stream Deck
            websocket.send(JSON.stringify({
                event: "setSettings",
                context: pluginAction,
                payload: settings
            }));
        }

        // Add event listeners
        document.getElementById("speakerIp").addEventListener("change", saveSettings);
        document.getElementById("volumeStep").addEventListener("change", saveSettings);

        // Initial status update
        updateDebugOutput('Property Inspector Loaded');
    </script>
</body>
</html> 